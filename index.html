<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPL_LAB</title>
  <style>
    /* 全局設定 */
    body {
      background: url('ipllogo.png') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
    }
    /* 主要內容區 */
    .content {
      min-height: 490px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* 資料區塊 */
    .data-section {
      margin-top: 350px;
      padding: 20px;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .data-section h2 {
      font-family: "Times New Roman", sans-serif;
      font-size: 28px;
      font-weight: bold;
      color: rgba(255, 204, 0, 0.89);
    }
    /* 表格樣式 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 26px;
      font-family: Verdana, sans-serif;
      font-size: 20px;
      color: #ffffff;
    }
    table, th, td {
      border: 1px solid #fff;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- 可依需求增加其他元素 -->
  <div class="content"></div>
  <div class="data-section">
    <h2>本週值日生</h2>
    <div id="result"></div>
  </div>

  <script>
    // 解析自訂日期字串 (容許：YYYY/MM/DD AM HH:mm、YYYY/MM/DD HH:mm AM、中文上午/下午；去除 \r/BOM)
    function parseCustomDate(str) {
      if (!str) return new Date('Invalid');
      let s = String(str)
        .replace(/^\uFEFF/, '')   // BOM
        .replace(/\r/g, '')       // CR
        .replace(/上午/g, 'AM')
        .replace(/下午/g, 'PM')
        .trim();

      // YYYY/MM/DD AM HH:mm
      let m = s.match(/^(\d{4}\/\d{1,2}\/\d{1,2})\s+(AM|PM)\s+(\d{1,2}):(\d{2})(?::\d{2})?$/i);
      if (m) {
        const [y, month, day] = m[1].split('/').map(Number);
        let hour = Number(m[3]), minute = Number(m[4]);
        const ap = m[2].toUpperCase();
        if (ap === 'PM' && hour < 12) hour += 12;
        if (ap === 'AM' && hour === 12) hour = 0;
        return new Date(y, month - 1, day, hour, minute);
      }

      // YYYY/MM/DD HH:mm AM
      m = s.match(/^(\d{4}\/\d{1,2}\/\d{1,2})\s+(\d{1,2}):(\d{2})(?::\d{2})?\s*(AM|PM)$/i);
      if (m) {
        const [y, month, day] = m[1].split('/').map(Number);
        let hour = Number(m[2]), minute = Number(m[3]);
        const ap = m[4].toUpperCase();
        if (ap === 'PM' && hour < 12) hour += 12;
        if (ap === 'AM' && hour === 12) hour = 0;
        return new Date(y, month - 1, day, hour, minute);
      }

      // 僅日期
      m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
      if (m) return new Date(+m[1], +m[2]-1, +m[3], 0, 0, 0);

      return new Date(s);
    }

    // 取得指定日期所屬週的星期一
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    // 解析 CSV 內容（保留你「排除第二行」，並對每格做 trim/去 \r/BOM/去外層引號）
    function parseCSV(csvText) {
      const lines = csvText.split('\n'); // 不整體 trim，避免吃掉首列
      const filtered = lines.filter((line, index) => index !== 1 && /\S/.test(line));
      return filtered.map(line =>
        line.split(',').map(cell =>
          String(cell)
            .replace(/\r/g, '')
            .replace(/^\uFEFF/, '')
            .replace(/^"(.*)"$/,'$1')
            .trim()
        )
      );
    }

    // 自訂標題 (11 欄)
    const customHeaders = [
      "日期",
      "洗手台/微波爐/冰箱/白板",
      "座位區掃地",
      "座位區拖地",
      "倒垃圾/回收",
      "濾網更換",
      "玄關整理",
      "實驗區靜電除塵拖",
      "實驗區垃圾桶清理",
      "實驗區準備桌清理",
      "光學桌排水/空壓機機油確認與排水"
    ];

    let sheetData = [];
    let currentWeekStart = getMonday(new Date());

    // 讀檔並自動判斷編碼：UTF-8 / UTF-16LE / UTF-16BE / Big5
    async function fetchTextWithEncoding(url){
      const res = await fetch(url, { cache: 'no-cache' });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const ab = await res.arrayBuffer();
      const u8 = new Uint8Array(ab);

      // 1) 先檢查 BOM
      if (u8.length >= 2) {
        if (u8[0] === 0xFF && u8[1] === 0xFE) { // UTF-16LE
          return new TextDecoder('utf-16le').decode(u8.subarray(2));
        }
        if (u8[0] === 0xFE && u8[1] === 0xFF) { // UTF-16BE
          return new TextDecoder('utf-16be').decode(u8.subarray(2));
        }
      }
      if (u8.length >= 3 && u8[0] === 0xEF && u8[1] === 0xBB && u8[2] === 0xBF) {
        return new TextDecoder('utf-8').decode(u8.subarray(3)); // UTF-8 BOM
      }

      // 2) 嘗試 UTF-8
      let txt = new TextDecoder('utf-8', { fatal: false }).decode(u8);

      // 若含大量 NUL，推定為無 BOM 的 UTF-16
      let nul = 0; for (let i=0;i<u8.length;i++) if (u8[i]===0x00) nul++;
      if (nul > u8.length / 6) {
        try { return new TextDecoder('utf-16le').decode(u8); } catch(_){}
        try { return new TextDecoder('utf-16be').decode(u8); } catch(_){}
      }

      // 3) 若仍有大量 �，再退回 Big5
      const bad = (txt.match(/\uFFFD/g) || []).length;
      if (bad > 8) {
        try { txt = new TextDecoder('big5').decode(u8); } catch(_){}
      }
      return txt;
    }

    // 載入 CSV 並更新畫面（只把 fetch→fetchTextWithEncoding，其餘不動）
    async function loadAndDisplayData() {
      try {
        const csvText = await fetchTextWithEncoding('IPLsheet.csv');
        sheetData = parseCSV(csvText);
        console.log("Parsed CSV data:", sheetData);
        displayWeekData(new Date());
      } catch (error) {
        console.error('CSV 讀取錯誤:', error);
      }
    }

    // 篩選本週資料並生成表格（略過表頭/空列/無效日期；保留你的特例與移位邏輯）
    function displayWeekData(targetDate) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';

      const weekStart = getMonday(targetDate);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 7);

      const filteredRows = sheetData.filter(row => {
        if (!row || !row[0]) return false;         // 空列
        if (/日期/.test(row[0])) return false;     // 表頭
        if (row[0] === "2025/04/07 AM 09:30") return false; // 你的特例
        const rowDate = parseCustomDate(row[0]);
        if (isNaN(rowDate)) return false;          // 解析失敗跳過
        rowDate.setHours(0, 0, 0, 0);
        return (rowDate >= weekStart && rowDate < weekEnd);
      });

      if (filteredRows.length === 0) {
        resultDiv.textContent = '沒有找到對應的資料';
        return;
      }

      // 生成表格（維持原樣）
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headerRow = document.createElement('tr');
      customHeaders.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      filteredRows.forEach(row => {
        if (row[1] === "0") {
          row.splice(1, 1);
          row.push("");
        }
        const tr = document.createElement('tr');
        for (let i = 0; i < customHeaders.length; i++) {
          const td = document.createElement('td');
          td.textContent = row[i] || "";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      resultDiv.appendChild(table);
    }

    // 初次載入資料
    loadAndDisplayData();

    // 每小時檢查是否跨週，若跨週則重新載入資料
    setInterval(() => {
      const now = new Date();
      const newWeekStart = getMonday(now);
      if (newWeekStart.getTime() !== currentWeekStart.getTime()) {
        currentWeekStart = newWeekStart;
        console.log("跨週更新資料");
        loadAndDisplayData();
      }
    }, 3600000);
  </script>
</body>
</html>
